# Use Case: UC-024 Export Setlist with Transition Notes

## Classification
- **Goal Level**: ðŸŒŠ User Goal
- **Scope**: System (black box)
- **Priority**: P2 Nice to Have
- **Complexity**: ðŸŸ¢ Low

## Actors
- **Primary Actor**: App User (authenticated, DJ)
- **Supporting Actors**:
  - Database (SQLx â€” setlist and track data)
- **Stakeholders & Interests**:
  - DJ User: Wants to take their setlist out of the app â€” print it for a gig, share with another DJ, import into DJ software (Rekordbox, Traktor, Serato), or save as a reference document
  - Developer: Wants export to be a simple transformation of existing data, no new external dependencies

## Conditions
- **Preconditions** (must be true before starting):
  1. User has a finalized setlist (from UC-016, optionally arranged by UC-017, optionally refined by UC-023)
  2. Setlist has at least 1 track

- **Success Postconditions** (true when done right):
  1. User receives an exported file in their chosen format containing: track order, track title, artist, BPM, key (Camelot), energy level, and transition notes between adjacent tracks
  2. Export includes the setlist metadata: original prompt, generation date, arrangement score (if arranged)
  3. Suggested tracks (not in catalog) are clearly marked as "To Acquire" with purchase links
  4. File is downloadable via the browser

- **Failure Postconditions** (true when it fails gracefully):
  1. If export generation fails, user receives an error message â€” setlist data is not affected
  2. If a format is unsupported, user is offered alternative formats

- **Invariants** (must remain true throughout):
  1. Export is read-only â€” does not modify the setlist
  2. Export happens client-side for v1 formats (CSV, JSON, Plain Text, Copy-to-Clipboard). PDF generation via server-side HTML template and headless Chromium is deferred to v2.
  3. No external API calls needed for export

## Main Success Scenario
1. User views a finalized setlist and taps "Export"
2. System presents format options: CSV, JSON, Plain Text, Copy-to-Clipboard (PDF deferred to v2)
3. User selects a format (default: CSV)
4. System generates the export file:
   - **Header**: Setlist name/prompt, date, total duration, average BPM, arrangement score
   - **Track listing**: Position, title, artist, BPM, key (Camelot), energy (1-8)
   - **Transition notes**: Between each pair of adjacent tracks â€” the LLM-generated transition guidance from UC-016/023
   - **Suggestions section**: Tracks marked as "To Acquire" with platform links (UC-020)
   - **Footer**: "Generated by Ethnomusicology" watermark
5. Browser downloads the file (or shares it via Web Share API on mobile)
6. User has the exported setlist for offline reference or sharing

## Extensions (What Can Go Wrong)

- **2a. User wants a format not listed**:
  1. System offers "Copy to Clipboard" as a universal fallback (plain text)
  2. Returns to step 2

- **3a. PDF export requested (v2 â€” not available in v1)**:
  1. System shows: "PDF export coming soon. Please choose CSV, JSON, or Plain Text."
  2. Returns to step 2

- **4a. Setlist has tracks with missing metadata (no BPM, no key)**:
  1. Export shows "â€”" for missing fields
  2. Does not block export

- **4b. Setlist has no transition notes (generated before UC-016 added them)**:
  1. Export omits transition notes section
  2. Shows track listing only

- **5a. Browser blocks the download (popup blocker)**:
  1. System shows a manual download link: "Click here to download your setlist"

## Variations

- **V1. Share Link**: Instead of downloading, generate a shareable URL that renders the setlist as a web page (public, read-only). Requires a simple static page renderer.
- **V2. Email Export**: User enters an email address, system sends the exported setlist as an attachment.
- **V3. Rekordbox XML**: Export as Rekordbox-compatible XML (V3 format) for direct import into Pioneer DJ software â€” a better target for DJ software integration than M3U since streaming tracks don't have local file paths.
- **V4. Print View**: Optimized print layout (CSS print stylesheet) â€” user hits Ctrl+P on the setlist page.

## Agent Execution Notes
- **Verification Command**: `cd backend && cargo test --test setlist_export`
- **Test File**: `backend/tests/setlist_export.rs`
- **Depends On**: UC-016 (setlists), UC-017 (arrangement scores, transition notes), UC-020 (purchase links for suggestions)
- **Blocks**: None
- **Estimated Complexity**: S (~1000 tokens implementation budget)
- **Agent Assignment**:
  - Teammate:Backend â€” Export endpoints: `GET /api/setlists/{id}/export?format=csv|json|txt`
  - Teammate:Frontend â€” Export modal with format picker, download trigger, copy-to-clipboard fallback

### Key Implementation Details
- **Formats (v1)**:
  - **CSV**: Simple row-per-track with headers (title, artist, bpm, key, energy, transition_note)
  - **JSON**: Direct serialization of setlist data structure
  - **Plain Text**: Formatted ASCII table with transition notes
  - **Copy-to-Clipboard**: Plain text format, universal fallback
- **Formats (v2)**: PDF generation via server-side HTML template and headless Chromium
- **M3U deferred**: M3U export deferred â€” streaming tracks don't have local file paths, making M3U of limited value. Rekordbox XML (V3 variation) is a better target for DJ software integration.
- **Download**: `Content-Disposition: attachment; filename="setlist-{name}-{date}.{ext}"`
- **No new migration needed** â€” reads existing setlist data

## Acceptance Criteria (for grading)
- [ ] All success postconditions verified
- [ ] CSV export is valid and importable into spreadsheet software
- [ ] JSON export is valid and parseable
- [ ] Plain text export is human-readable
- [ ] Suggested tracks clearly marked as "To Acquire"
- [ ] Missing metadata shown as "â€”" without blocking export
- [ ] Download works in Chrome, Firefox, Safari
- [ ] Copy-to-clipboard fallback works when download is blocked
